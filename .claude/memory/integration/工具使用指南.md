# 委托文件生成工具使用指南

> 版本: v1.0
> 更新日期: 2025-11-14

## 概述

本文档介绍如何在SuitAgent系统中使用委托文件生成功能。

## 环境准备

### 依赖安装

在使用委托文件生成工具前，需要安装以下Python包：

```bash
pip install python-docx pyyaml
```

如果遇到权限问题，可以使用用户安装：

```bash
pip install --user python-docx pyyaml
```

或使用虚拟环境：

```bash
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# 或 venv\Scripts\activate  # Windows
pip install python-docx pyyaml
```

### 目录结构

确保以下目录结构存在：

```
SuitAgent/
├── .claude/
│   ├── tools/                  # 工具目录
│   │   ├── placeholder_mapper.py  # 字段映射工具
│   │   ├── DocxProcessor.py       # Word文档处理工具
│   │   └── docx_tools.py          # 工具包装函数
│   └── templates/              # 模板目录
│       ├── 公司委托模板/           # 公司委托文件模板目录
│       │   ├── 002律师服务质量监督卡存根.docx
│       │   ├── 003谈话笔录.docx
│       │   ├── 004委托代理合同.docx
│       │   ├── 005授权委托书（公司）.docx
│       │   └── ...
│       └── 个人委托模板/           # 个人委托文件模板目录
│           ├── 002律师服务质量监督卡存根.docx
│           ├── 003谈话笔录.docx
│           ├── 004委托代理合同.docx
│           ├── 005授权委托书（个人）.docx
│           └── ...
└── output/
    └── [案件编号]/
        ├── 04_法律文书/
        │   └── 委托文件/
        └── [案件编号].yaml
```

## 快速开始

### 步骤1: 创建案件YAML文件

```python
from tools.docx_tools import create_case_yaml_template

# 创建YAML模板
case_id = "[2025]京0105民初1234号"
yaml_path = f"output/{case_id}/{case_id}.yaml"

create_case_yaml_template(case_id, yaml_path)
```

手动填写YAML文件内容：

```yaml
案件编号: "[2025]京0105民初1234号"

案件基本信息:
  委托人信息:
    client_name: "张三有限公司"
    client_type: "公司"
    client_code: "912345678901234567"
    client_address: "北京市朝阳区xxx街道123号"
    legal_representative: "李四"
    representative_position: "总经理"

  律师信息:
    lawyer_name: "王五"
    lawyer_contact: "13800000000"

  案件信息:
    opposing_party: "北京某某公司"
    case_cause: "买卖合同纠纷"
    case_type: "民事案件"
    client_vs_opponent: "张三有限公司诉北京某某公司"

日期信息:
  year: "2025"
  month: "11"
  day: "14"
```

### 步骤2: 准备Word模板

使用已准备好的模板文件：

- **公司委托**: 使用 `.claude/templates/公司委托模板/` 目录中的文件
- **个人委托**: 使用 `.claude/templates/个人委托模板/` 目录中的文件

模板中已预置占位符，直接使用即可：

```
委托书

委托人：{client}，{type}，统一社会信用代码/身份证号：{code}，
住所地：{address}，法定代表人：{representative}，职务：{position}。

受托人：{lawyer}律师，联系电话：{tel}。

委托事项：
关于{client_opponent}一案（案由：{case_cause}，案件类型：{case_type}），
现委托上述受托人作为我方的委托代理人。

委托期限：自{year}年{month}月{day}日至案件终结。

委托人（签字/盖章）：
{year}年{month}月{day}日
```

### 步骤3: 生成委托文件

#### 生成单个文件

```python
from tools.docx_tools import generate_trust_document

case_id = "[2025]京0105民初1234号"
yaml_path = f"output/{case_id}/{case_id}.yaml"
output_dir = f"output/{case_id}/04_法律文书"
template_name = "委托合同模板.docx"

output_path = generate_trust_document(
    case_id=case_id,
    template_name=template_name,
    yaml_path=yaml_path,
    output_dir=output_dir
)

print(f"生成成功: {output_path}")
```

#### 批量生成文件

```python
from tools.docx_tools import batch_generate_trust_documents

case_id = "[2025]京0105民初1234号"
yaml_path = f"output/{case_id}/{case_id}.yaml"
output_dir = f"output/{case_id}/04_法律文书"

templates = [
    "委托合同模板.docx",
    "授权委托书模板.docx",
    "谈话笔录模板.docx"
]

output_paths = batch_generate_trust_documents(
    case_id=case_id,
    yaml_path=yaml_path,
    output_dir=output_dir,
    templates=templates
)

print(f"成功生成 {len(output_paths)} 个文件:")
for path in output_paths:
    print(f"  - {path}")
```

## API参考

### placeholder_mapper.py

#### PlaceholderMapper类

##### yaml_to_placeholders(yaml_data)

将YAML数据转换为占位符字典。

**参数:**
- `yaml_data` (dict): 案件YAML数据

**返回值:**
- `dict`: 占位符字典 {占位符: 值}

**示例:**

```python
from tools.placeholder_mapper import PlaceholderMapper
import yaml

# 加载YAML文件
with open('case.yaml', 'r', encoding='utf-8') as f:
    yaml_data = yaml.safe_load(f)

# 转换为占位符
placeholders = PlaceholderMapper.yaml_to_placeholders(yaml_data)

print(placeholders)
# {'client': '张三有限公司', 'lawyer': '王五', ...}
```

##### load_yaml_from_file(yaml_file_path)

从文件加载YAML数据。

**参数:**
- `yaml_file_path` (str): YAML文件路径

**返回值:**
- `dict`: YAML数据

**异常:**
- `FileNotFoundError`: 文件不存在
- `yaml.YAMLError`: YAML格式错误

##### validate_required_fields(placeholders)

验证必填字段是否完整。

**参数:**
- `placeholders` (dict): 占位符字典

**返回值:**
- `list`: 缺失的必填字段列表

**示例:**

```python
missing = PlaceholderMapper.validate_required_fields(placeholders)
if missing:
    print(f"缺失字段: {', '.join(missing)}")
else:
    print("所有必填字段完整")
```

### DocxProcessor.py

#### DocxProcessor类

##### process_document(template_path, output_path, replace_dict)

处理单个Word文档模板。

**参数:**
- `template_path` (str): 模板文件路径
- `output_path` (str): 输出文件路径
- `replace_dict` (dict): 占位符字典

**返回值:**
- `bool`: 是否成功

**示例:**

```python
from tools.DocxProcessor import DocxProcessor

placeholders = {
    'client': '张三',
    'lawyer': '李四',
    'date': '2025-11-14'
}

success = DocxProcessor.process_document(
    'template.docx',
    'output.docx',
    placeholders
)

if success:
    print("文档生成成功")
```

##### process_from_yaml(template_path, output_path, yaml_file_path)

从YAML文件生成Word文档。

**参数:**
- `template_path` (str): Word模板路径
- `output_path` (str): 输出文件路径
- `yaml_file_path` (str): 案件YAML文件路径

**返回值:**
- `bool`: 是否成功

**示例:**

```python
from tools.DocxProcessor import DocxProcessor

success = DocxProcessor.process_from_yaml(
    'template.docx',
    'output.docx',
    'case.yaml'
)
```

##### process_directory(template_dir, output_dir, replace_dict)

批量处理目录中的所有Word文档模板。

**参数:**
- `template_dir` (str): 模板目录路径
- `output_dir` (str): 输出目录路径
- `replace_dict` (dict): 占位符字典

**返回值:**
- `List[Tuple[str, bool]]`: 处理结果列表

**示例:**

```python
from tools.DocxProcessor import DocxProcessor

results = DocxProcessor.process_directory(
    'templates/',
    'output/',
    {'client': '张三', 'lawyer': '李四'}
)

for filename, success in results:
    status = "成功" if success else "失败"
    print(f"{filename}: {status}")
```

### docx_tools.py

#### 便捷函数

##### generate_trust_document(case_id, template_name, yaml_path, output_dir)

生成单个委托文件。

##### batch_generate_trust_documents(case_id, yaml_path, output_dir, templates)

批量生成委托文件。

##### create_case_yaml_template(case_id, output_path)

创建案件YAML模板文件。

##### validate_yaml_file(yaml_path)

验证YAML文件的完整性。

##### get_template_list(template_dir)

获取可用模板列表。

## 占位符说明

### 支持的占位符

| 占位符 | 说明 | 示例值 |
|-------|------|--------|
| `{client}` | 委托人名称 | 张三有限公司 |
| `{type}` | 委托人类型 | 公司 |
| `{code}` | 统一社会信用代码/身份证号 | 912345678901234567 |
| `{address}` | 住所地/地址 | 北京市朝阳区xxx街道 |
| `{representative}` | 法定代表人 | 李四 |
| `{position}` | 法定代表人职位 | 总经理 |
| `{lawyer}` | 律师姓名 | 王五 |
| `{tel}` | 联系电话 | 13800000000 |
| `{opposite}` | 对方当事人 | 北京某某公司 |
| `{cause}` | 案由 | 买卖合同纠纷 |
| `{case_type}` | 案件类型 | 民事案件 |
| `{client_opponent}` | 委托人与对方关系 | 张三有限公司诉北京某某公司 |
| `{year}` | 年份 | 2025 |
| `{month}` | 月份（两位数） | 11 |
| `{day}` | 日期（两位数） | 14 |

### 使用示例

**模板内容:**

```
委托人：{client}，{type}，统一社会信用代码/身份证号：{code}，
住所地：{address}，法定代表人：{representative}，职务：{position}。
```

**替换结果:**

```
委托人：张三有限公司，公司，统一社会信用代码/身份证号：912345678901234567，
住所地：北京市朝阳区xxx街道，法定代表人：李四，职务：总经理。
```

## 常见问题

### Q: 为什么生成的Word文档格式丢失？

**A:** 确保模板文件是`.docx`格式（不是`.doc`），并且占位符在同一个run中。如果格式仍然丢失，请检查占位符名称是否正确。

### Q: 表格中的占位符没有被替换？

**A:** DocxProcessor会自动处理表格中的占位符，确保占位符格式正确（包含大括号）。

### Q: 如何处理缺失的必填字段？

**A:** 使用`validate_yaml_file()`函数检查YAML文件，查看缺失的字段列表，然后补充完整。

### Q: 可以自定义占位符吗？

**A:** 可以。在YAML文件中添加自定义字段，然后在占位符字典中包含该字段，模板中即可使用`{自定义占位符}`。

### Q: 支持批量处理多个案件吗？

**A:** 可以。遍历案件列表，为每个案件调用`batch_generate_trust_documents()`函数。

## 错误处理

### 常见错误及解决方法

1. **FileNotFoundError: 模板文件不存在**
   - 检查模板文件路径是否正确
   - 确保模板文件在`.claude/templates/公司委托模板/`或`.claude/templates/个人委托模板/`目录中

2. **yaml.YAMLError: 格式错误**
   - 检查YAML文件语法
   - 确保缩进正确（使用空格，不使用Tab）

3. **KeyError: 字段不存在**
   - 检查YAML文件字段名是否正确
   - 参考字段对照表文档

4. **python-docx未安装**
   - 运行`pip install python-docx`安装依赖

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v1.0 | 2025-11-14 | 初始版本，支持基础委托文件生成功能 |

## 相关文档

- [字段对照表](字段对照表.md) - 详细字段映射说明
- [委托确定工作流](委托确定工作流.md) - 完整工作流说明
- [Word模板处理器](../.../docs/委托文件生成/word_template_processor.py) - 原始处理代码
- [Writer Agent配置](../agents/Writer.md) - Agent配置文档