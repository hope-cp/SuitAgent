# 委托确定工作流

> 版本: v1.0
> 更新日期: 2025-11-14
> 适用场景: 正式委托阶段

## 概述

委托确定工作流是SuitAgent系统中专门处理客户正式委托场景的完整工作流。该工作流将自动生成完整的委托材料包，包括法律风险告知书、委托代理合同、授权委托书等全套文件。

## 触发场景

以下关键词将自动触发委托确定工作流：

- "确定委托"
- "签署委托"
- "办理委托"
- "委托材料"
- "制作委托"
- "委托文件生成"
- "客户委托"
- "律师委托"

## 完整流程

```
┌─────────────────────────────────────────────────────────────┐
│                    委托确定工作流                             │
└─────────────────────────────────────────────────────────────┘

1. DocAnalyzer(客户信息确认)
   ↓
2. Writer(生成委托文件)
   ├─ 002律师服务质量监督卡存根.docx
   ├─ 003谈话笔录.docx
   ├─ 004委托代理合同.docx
   ├─ 005授权委托书(公司/个人).docx
   └─ 007法律文书送达地确认书.docx
   ↓
3. Summarizer(委托清单摘要)
   ↓
4. Reporter(整合完整报告)
   ↓
输出：完整的委托材料包
```

## 输入要求

### 必需材料

1. **案件YAML文件**
   - 路径: `output/[案件编号]/[案件编号].yaml`
   - 包含完整案件信息和委托信息

2. **客户信息确认**
   - 委托人姓名/名称
   - 委托类型（公司/个人）
   - 联系方式
   - 地址信息

3. **委托范围确认**
   - 诉讼阶段（一审/二审/再审）
   - 委托事项（起诉/应诉/执行等）
   - 特别授权事项

### YAML文件示例

```yaml
案件编号: "[2025]京0105民初1234号"

案件基本信息:
  委托人信息:
    client_name: "张三有限公司"
    client_type: "公司"  # 或 "个人"
    client_code: "912345678901234567"
    client_address: "北京市朝阳区xxx街道123号"
    legal_representative: "李四"
    representative_position: "总经理"

  律师信息:
    lawyer_name: "王五"
    lawyer_contact: "13800000000"

  案件信息:
    opposing_party: "北京某某公司"
    case_cause: "买卖合同纠纷"
    case_type: "民事案件"
    client_vs_opponent: "张三有限公司诉北京某某公司"

日期信息:
  year: "2025"
  month: "11"
  day: "14"
```

## 工作流详解

### 步骤1: DocAnalyzer（客户信息确认）

**职责**: 分析和确认客户提供的委托相关信息

**执行内容**:
- 读取案件YAML文件
- 验证客户信息完整性
- 确认委托类型（公司/个人）
- 提取关键委托信息

**输出**:
- 客户信息确认报告
- 委托类型标识（company/person）

### 步骤2: Writer（生成委托文件）

**职责**: 基于模板批量生成Word格式委托文件

**执行内容**:

#### 2.1 根据委托类型选择模板
- **公司委托**: 使用 `.claude/templates/公司委托模板/`
- **个人委托**: 使用 `.claude/templates/个人委托模板/`

#### 2.2 生成核心委托文件
必生成文件（5个）:
1. `002律师服务质量监督卡存根.docx` - 律师服务质量监督
2. `003谈话笔录.docx` - 客户委托确认记录
3. `004委托代理合同.docx` - 法律服务委托合同
4. `005授权委托书(公司/个人).docx` - 诉讼代理授权
5. `007法律文书送达地确认书.docx` - 文书送达地址确认

可选生成文件:
- `000委托文件清单.docx` - 委托文件清单
- `001法律风险告知书.docx` - 风险告知
- `006法定代表人身份证明.docx` - 公司专属
- `008函.docx` - 正式函件

#### 2.3 字段映射
使用占位符映射系统，自动替换以下字段:

| 占位符 | 说明 | 示例 |
|-------|------|------|
| `{client}` | 委托人名称 | 张三有限公司 |
| `{type}` | 委托类型 | 公司/个人 |
| `{lawyer}` | 律师姓名 | 王五 |
| `{tel}` | 联系电话 | 13800000000 |
| `{date}` | 日期 | 2025年11月14日 |
| ... | ... | ... |

#### 2.4 执行命令示例

```python
from tools.docx_tools import batch_generate_trust_documents

# 确定委托类型
client_type = "company" if client_info['client_type'] == '公司' else "person"

# 批量生成委托文件
templates = [
    "002律师服务质量监督卡存根.docx",
    "003谈话笔录.docx",
    "004委托代理合同.docx",
    "005授权委托书(公司).docx" if client_type == "company" else "005授权委托书(个人).docx",
    "007 法律文书送达地确认书.docx"
]

output_paths = batch_generate_trust_documents(
    case_id="[2025]京0105民初1234号",
    yaml_path="output/[2025]京0105民初1234号/[2025]京0105民初1234号.yaml",
    output_dir="output/[2025]京0105民初1234号/04_法律文书",
    templates=templates,
    client_type=client_type
)
```

**质量检查**:
- [ ] 所有文件生成成功
- [ ] 占位符全部替换
- [ ] 格式保持完整
- [ ] 文件命名正确

### 步骤3: Summarizer（委托清单摘要）

**职责**: 生成委托材料清单摘要

**执行内容**:
- 汇总所有生成的委托文件
- 统计文件数量和类型
- 生成委托清单摘要
- 提供使用说明

**输出**:
- `委托材料清单摘要.md`
- 包含文件列表、用途说明、使用指南

### 步骤4: Reporter（整合完整报告）

**职责**: 生成完整的委托材料包报告

**执行内容**:
- 整合所有委托文件信息
- 添加流程说明
- 提供完整的委托材料包
- 生成最终交付报告

**输出**:
- `完整委托材料包.md` - 包含所有文件和说明
- `交付清单.md` - 详细交付清单

## 输出内容

### 完整委托材料包包含

#### 必选文件（5个）
1. **律师服务质量监督卡存根**
   - 用途：客户对律师服务的监督凭证
   - 格式：Word文档
   - 存放：`04_法律文书/委托文件/`

2. **谈话笔录**
   - 用途：记录客户委托确认过程
   - 格式：Word文档
   - 存放：`04_法律文书/委托文件/`

3. **委托代理合同**
   - 用途：法律服务委托合同
   - 格式：Word文档
   - 存放：`04_法律文书/委托文件/`

4. **授权委托书**
   - 用途：诉讼代理授权（公司版/个人版）
   - 格式：Word文档
   - 存放：`04_法律文书/委托文件/`

5. **法律文书送达地确认书**
   - 用途：确认法律文书送达地址
   - 格式：Word文档
   - 存放：`04_法律文书/委托文件/`

#### 可选文件（根据需要）
6. **委托文件清单** - 全部文件清单
7. **法律风险告知书** - 风险提示
8. **法定代表人身份证明** - 公司专属
9. **函** - 正式函件

#### 摘要报告（2个）
10. **委托材料清单摘要.md** - 清单摘要
11. **完整委托材料包.md** - 完整报告

### 文件命名规范

- **输出路径**: `output/[案件编号]/04_法律文书/委托文件/`
- **文件命名**: `[案件编号]_[模板文件名]`
- **示例**: `[2025]京0105民初1234号_002律师服务质量监督卡存根.docx`

## 使用场景

### 场景1：公司委托

```python
# 客户：张三有限公司
# 委托类型：公司
client_type = "company"

# 自动选择公司模板
templates = [
    "002律师服务质量监督卡存根.docx",
    "003谈话笔录.docx",
    "004委托代理合同.docx",
    "005授权委托书（公司）.docx",
    "006法定代表人身份证明.docx",
    "007 法律文书送达地确认书.docx"
]
```

### 场景2：个人委托

```python
# 客户：张三（自然人）
# 委托类型：个人
client_type = "person"

# 自动选择个人模板
templates = [
    "002律师服务质量监督卡存根.docx",
    "003谈话笔录.docx",
    "004委托代理合同.docx",
    "005授权委托书（个人）.docx",
    "007 法律文书送达地确认书.docx"
]
```

## 快速启动

### 在SuitAgent中启动

用户可以直接说：
- "我需要制作委托材料"
- "客户确定委托，请生成委托文件"
- "为公司客户制作完整的委托材料包"

系统会自动识别并启动委托确定工作流。

### 手动启动

也可以通过编程方式手动启动：

```python
from tools.docx_tools import batch_generate_trust_documents

# 确定案件信息
case_id = "[2025]京0105民初1234号"
yaml_path = f"output/{case_id}/{case_id}.yaml"
output_dir = f"output/{case_id}/04_法律文书"

# 根据客户类型选择模板
client_type = "company"  # 或 "person"

# 批量生成
output_paths = batch_generate_trust_documents(
    case_id=case_id,
    yaml_path=yaml_path,
    output_dir=output_dir,
    templates=[
        "002律师服务质量监督卡存根.docx",
        "003谈话笔录.docx",
        "004委托代理合同.docx",
        "005授权委托书（公司）.docx",
        "007 法律文书送达地确认书.docx"
    ],
    client_type=client_type
)

print(f"成功生成 {len(output_paths)} 个委托文件")
```

## 质量保证

### 自动检查

1. **模板存在性检查**
   - 验证模板文件是否存在
   - 检查模板是否可读

2. **数据完整性检查**
   - 验证YAML文件格式
   - 检查必填字段
   - 确认占位符映射

3. **输出验证**
   - 验证文件生成成功
   - 检查文件完整性
   - 确认命名规范

### 手动检查清单

- [ ] 确认委托类型正确（公司/个人）
- [ ] 验证客户信息准确
- [ ] 检查所有文件已生成
- [ ] 确认占位符全部替换
- [ ] 验证文件格式完整
- [ ] 检查文件命名正确

## 故障排除

### 常见问题

#### 问题1: 模板文件不存在
**错误**: `FileNotFoundError: 模板文件不存在`

**原因**:
- 模板路径错误
- 文件权限问题

**解决方法**:
```python
# 检查模板目录
import os
template_dir = ".claude/templates/公司委托模板"
if os.path.exists(template_dir):
    print("模板目录存在")
    print(os.listdir(template_dir))
else:
    print("模板目录不存在")
```

#### 问题2: 缺失必填字段
**错误**: 某些占位符未被替换

**原因**:
- YAML文件中缺失必要字段
- 字段名不匹配

**解决方法**:
```python
from tools.placeholder_mapper import PlaceholderMapper

# 验证YAML
yaml_data = PlaceholderMapper.load_yaml_from_file("case.yaml")
placeholders = PlaceholderMapper.yaml_to_placeholders(yaml_data)
missing = PlaceholderMapper.validate_required_fields(placeholders)

if missing:
    print(f"缺失字段: {missing}")
    # 补充缺失字段
```

#### 问题3: 格式丢失
**现象**: 生成的Word文档格式不正确

**原因**:
- 模板文件损坏
- 占位符格式错误

**解决方法**:
- 重新检查模板文件
- 确认占位符格式正确（使用大括号）

### 调试模式

启用详细日志：

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## 相关文档

- [字段对照表](字段对照表.md) - 详细字段映射
- [工具使用指南](工具使用指南.md) - API参考
- [Writer Agent配置](../../.claude/agents/Writer.md) - Agent配置
- [测试指南](测试指南.md) - 测试说明

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v1.0 | 2025-11-14 | 初始版本，支持公司/个人两种委托模板 |

## 联系支持

如有问题，请查阅相关文档或联系开发团队。
